#! /usr/bin/env ruby

require 'json'

CHROME = "google-chrome-beta"

def get_profiles
  profiles = {}
  Dir.chdir File.join(ENV["HOME"], ".config", CHROME) do
    Dir["*/Preferences"].each do |preferences_file|
      preferences = JSON.load File.read(preferences_file)
      profiles[File.dirname(preferences_file)] = preferences["profile"]["name"]
    end
  end
  profiles.sort_by { |k,v| v }.to_h
end

def _usage_and_exit
  puts "USAGE: #{File.basename(__FILE__)} <profile-name>"
  puts
  puts "       where <profile-name> is one of:"
  puts
  profiles = get_profiles
  profiles.each do |directory, name|
    puts "       - \"#{name}\" (#{directory})"
  end
  puts "       - \"incognito\""
  puts
  puts "       and may be case-insensitive or partial"
  puts
  exit 1
end

def search_for query
  get_profiles.find { |k,v| profile_match(query, v) }
end

def launch_command command
  %Q{#{command} > /dev/null 2>&1 &}
end

def profile_match query, profile_name
  profile_name.downcase =~ /^#{query}/
end

query = ARGV[0]
_usage_and_exit unless query
query = query.downcase

command =
  if profile_match(query, "incognito")
    launch_command %Q{#{CHROME} --incognito}
  else
    profile = search_for query
    _usage_and_exit unless profile

    profile_name = profile.first
    launch_command %Q{#{CHROME} --profile-directory="#{profile_name}"}
  end

puts command
system command

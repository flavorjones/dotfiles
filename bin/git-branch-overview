#! /usr/bin/env ruby

require 'date'

bold = "\e[1m"
reset = "\e[0m"

def _usage
  puts "USAGE: git-branch-overview [origin|local]"
  exit 1
end

branches = case ARGV[0]
           when "origin"
             `git branch -r | fgrep origin/ | fgrep -v origin/HEAD`.split("\n").map(&:strip)
           when "local"
             `git branch | cut -c2-`.split("\n").map(&:strip).reject { |b| b =~ /^master$/ }
           else
             _usage
           end

branches_dates = branches.inject({}) do |hash, branch|
  date = Date.parse `git log -n1 --format='%ai' #{branch}`.split(" ").first
  hash[branch] = date
  hash
end

branches_logs = branches.inject({}) do |hash, branch|
  commit = `git log -n1 #{branch} --pretty=short`
  hash[branch] = commit
  hash
end

branches_dates
  .sort_by { |branch, date| date }
  .reverse
  .each do |branch, date|
      puts "----------"
      puts "#{bold}#{date}: #{branch}#{reset}"
      puts
      puts branches_logs[branch]
      puts
end

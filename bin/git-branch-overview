#! /usr/bin/env ruby

require 'getoptlong'
require 'date'

def _usage
  puts "USAGE: git-branch-overview [--help|-h] [<remote>]"
  exit 1
end

begin
  GetoptLong.new(
    ["--help", "-h", GetoptLong::NO_ARGUMENT],
  ).each do |opt, arg|
    case opt
    when "--help"
      _usage
    end
  end
rescue GetoptLong::InvalidOption
  _usage
end

remote = ARGV[0]

branches = if remote.nil? # local
             `git branch | cut -c2-`
               .split("\n").map(&:strip)
               .reject { |b| b =~ /^master$/ }
           else
             `git branch -r | egrep '^\\s+#{remote}/'`
               .split("\n").map(&:strip)
               .reject { |b| b =~ %r{^#{remote}/(master$|HEAD)} }
           end

branches_dates = branches.inject({}) do |hash, branch|
  date = Date.parse `git log -n1 --format='%ai' #{branch}`.split(" ").first
  hash[branch] = date
  hash
end

branches_logs = branches.inject({}) do |hash, branch|
  commit = `git log --color --decorate=short --date=iso8601 -n1 #{branch}`
  hash[branch] = commit + "\n"
  hash
end

pager_command = ENV['GIT_PAGER'] || ENV['PAGER']
pager = begin
          pager_command ? IO.popen(pager_command, "w") : STDOUT
        rescue
          STDOUT
        end

branches_dates
  .sort_by { |branch, date| date }
  .reverse
  .each { |branch, date| pager.puts branches_logs[branch] }

pager.close
